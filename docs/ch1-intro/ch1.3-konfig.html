<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Konfig 模型库 - KusionStack 实战</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="如何用 KusionStack 部署运维 Kubernetes 应用">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../book.html">封面</a></li><li class="chapter-item expanded affix "><a href="../preface.html">前言</a></li><li class="chapter-item expanded "><a href="../ch1-intro/index.html"><strong aria-hidden="true">1.</strong> 简介</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ch1-intro/ch1.1-backend.html"><strong aria-hidden="true">1.1.</strong> 背景</a></li><li class="chapter-item expanded "><a href="../ch1-intro/ch1.2-kcl.html"><strong aria-hidden="true">1.2.</strong> KCL 语言</a></li><li class="chapter-item expanded "><a href="../ch1-intro/ch1.3-konfig.html" class="active"><strong aria-hidden="true">1.3.</strong> Konfig 模型库</a></li><li class="chapter-item expanded "><a href="../ch1-intro/ch1.4-kusion.html"><strong aria-hidden="true">1.4.</strong> Kusion 用户界面</a></li><li class="chapter-item expanded "><a href="../ch1-intro/ch1.5-ide.html"><strong aria-hidden="true">1.5.</strong> IDE 插件</a></li></ol></li><li class="chapter-item expanded "><a href="../ch2-hello-kusion/index.html"><strong aria-hidden="true">2.</strong> 你好 Kusion</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ch2-hello-kusion/ch2.1-init.html"><strong aria-hidden="true">2.1.</strong> 初始化工程</a></li><li class="chapter-item expanded "><a href="../ch2-hello-kusion/ch2.2-apply.html"><strong aria-hidden="true">2.2.</strong> Apply 子命令</a></li></ol></li><li class="chapter-item expanded "><a href="../ch3-internal/index.html"><strong aria-hidden="true">3.</strong> Kusion 核心概念</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ch3-internal/ch3.1-arch.html"><strong aria-hidden="true">3.1.</strong> 整体架构</a></li><li class="chapter-item expanded "><a href="../ch3-internal/ch3.2-project-stack.html"><strong aria-hidden="true">3.2.</strong> Project &amp; Stack</a></li><li class="chapter-item expanded "><a href="../ch3-internal/ch3.3-state-backends.html"><strong aria-hidden="true">3.3.</strong> State &amp; Backends</a></li><li class="chapter-item expanded "><a href="../ch3-internal/ch3.4-connect-x.html"><strong aria-hidden="true">3.4.</strong> 和上游下游的关系</a></li></ol></li><li class="chapter-item expanded "><a href="../ch4-devops/index.html"><strong aria-hidden="true">4.</strong> 场景: 日常运维</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ch4-devops/ch4.1-deploy.html"><strong aria-hidden="true">4.1.</strong> 部署 Deployment</a></li><li class="chapter-item expanded "><a href="../ch4-devops/ch4.2-monitor.html"><strong aria-hidden="true">4.2.</strong> 为应用配置监控</a></li><li class="chapter-item expanded "><a href="../ch4-devops/ch4.3-expand-resource-cap.html"><strong aria-hidden="true">4.3.</strong> 扩展应用资源容量</a></li><li class="chapter-item expanded "><a href="../ch4-devops/ch4.4-app-image-upgrade.html"><strong aria-hidden="true">4.4.</strong> 镜像升级</a></li><li class="chapter-item expanded "><a href="../ch4-devops/ch4.5-ext.html"><strong aria-hidden="true">4.5.</strong> 补充说明</a></li></ol></li><li class="chapter-item expanded "><a href="../ch5-connect-x/index.html"><strong aria-hidden="true">5.</strong> 场景: 对接社区生态</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ch5-connect-x/ch5.1-openapi.html"><strong aria-hidden="true">5.1.</strong> OpenAPI</a></li><li class="chapter-item expanded "><a href="../ch5-connect-x/ch5.2-terraform.html"><strong aria-hidden="true">5.2.</strong> Terraform</a></li></ol></li><li class="chapter-item expanded "><a href="../ch6-multi-cloud/index.html"><strong aria-hidden="true">6.</strong> 多平台: 对接阿里云生态</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ch6-multi-cloud/ch6.1-ecs.html"><strong aria-hidden="true">6.1.</strong> ECS 云主机</a></li><li class="chapter-item expanded "><a href="../ch6-multi-cloud/ch6.2-slb.html"><strong aria-hidden="true">6.2.</strong> SLB 负载均衡</a></li></ol></li><li class="chapter-item expanded "><a href="../ch7-opensource/index.html"><strong aria-hidden="true">7.</strong> 开源社区</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ch7-opensource/ch7.1-support.html"><strong aria-hidden="true">7.1.</strong> 寻求帮助</a></li><li class="chapter-item expanded "><a href="../ch7-opensource/ch7.2-contribute-docs.html"><strong aria-hidden="true">7.2.</strong> 贡献文档</a></li><li class="chapter-item expanded "><a href="../ch7-opensource/ch7.3-contribute-code.html"><strong aria-hidden="true">7.3.</strong> 贡献代码</a></li></ol></li><li class="chapter-item expanded "><a href="../appendix/index.html"><strong aria-hidden="true">8.</strong> 附录</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../appendix/a-faq.html"><strong aria-hidden="true">8.1.</strong> 附录 A: FAQ</a></li><li class="chapter-item expanded "><a href="../appendix/b-kcl.html"><strong aria-hidden="true">8.2.</strong> 附录 B: KCL 语法</a></li><li class="chapter-item expanded "><a href="../appendix/c-ref.html"><strong aria-hidden="true">8.3.</strong> 附录 C: 链接</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">KusionStack 实战</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/KusionStack/kusion-in-action-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/KusionStack/kusion-in-action-book/blob/main/./ch1-intro/ch1.3-konfig.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="13-konfig-模型库"><a class="header" href="#13-konfig-模型库">1.3 Konfig 模型库</a></h1>
<p>Konfig 是 Kusion 内置的基础配置模型库（ Kuison+config 的组合词）。本节将展示如何通过 KCL 语言为已有的 YAML 配置建模，从而构建一个自己的模型库——这也是 Konfig 的雏形。最后简单介绍 Konfig 诞生的背景。</p>
<h2 id="131-yaml-建模"><a class="header" href="#131-yaml-建模">1.3.1 YAML 建模</a></h2>
<p>YAML 是用来写配置文件的语言，非常简洁和强大，目前是 Kubernetes 官方钦定的首选配置交换格式。YAML 很灵活也很好写，同时也很容易出错！比如 Kubernetes 官网的 <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">Nginx-Deployment</a> 例子：</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    spec:
      containers:
      - image: nginx:1.14.2
        name: nginx
        ports:
        - containerPort: 80
</code></pre>
<p>该例子部署一个 Nginx 服务。如果我们不小心写错其中的某个配置，并且不能在第一时间发现，那么可能带来未知的风险。其实对于 Kubernetes 语境来说，这个 <code>Deployment</code> 配置是有着明确的定义的：每个字段的名字和类型、以及相关字段的值需要满足一定的规则等。通过定制面向领域的 DSL 语言来提升配置的安全性正是设计 KCL 语言的初衷。</p>
<p>我们可以尝试用 KCL 给 <code>Deployment</code> 配置建模：</p>
<pre><code class="language-py">schema Deployment:
    final apiVersion: str = &quot;apps/v1&quot;
    final kind: str = &quot;Deployment&quot;

    metadata?: apis_ObjectMeta
    spec?: DeploymentSpec
</code></pre>
<p>我们首选通过 KCL 的 <code>schema</code> 关键字定义一个 <code>Deployment</code> 模型。其中的 <code>apiVersion</code> 和 <code>kind</code> 字段有着固定的类型和值，因此我们通过 <code>final</code> 和默认值的特性描述。而对于复杂的 <code>metadata</code> 和 <code>spec</code> 字段则通过新的 <code>ObjectMeta</code> 和 <code>DeploymentSpec</code> 模型描述，它们的字段名均已问号结尾表示是可选的字段。</p>
<p><code>ObjectMeta</code> 模型的全部属性有很多，目前只定义需要的部分如下：</p>
<pre><code class="language-py">schema ObjectMeta:
    name?: str
    namespace?: str
</code></pre>
<p>同样 <code>DeploymentSpec</code> 模型的定义如下：</p>
<pre><code class="language-py">schema DeploymentSpec:
    replicas?: int
    selector: LabelSelector
    template: PodTemplateSpec
</code></pre>
<p>其中 <code>replicas</code> 是一个可选字段，<code>selector</code> 和 <code>template</code> 字段则继续用新模型描述。</p>
<p><code>LabelSelector</code> 模型用户描述 Label 选择的参数，定义如下：</p>
<pre><code class="language-py">schema LabelSelector:
    matchLabels?: {str:str}
</code></pre>
<p>其中 <code>matchLabels</code> 字段是一个 dict 字典类型，字典的 Key 和 Value 都是字符串。</p>
<p><code>PodTemplateSpec</code> 模型定义如下：</p>
<pre><code class="language-py">schema PodTemplateSpec:
    metadata?: ObjectMeta
    spec?: PodSpec

schema PodSpec:
    containers: [Container]

schema Container:
    image?: str
    name: str
    ports?: [ContainerPort]

schema ContainerPort:
    containerPort: int

</code></pre>
<p>其中 <code>metadata</code> 字段用的是已经定义的 <code>ObjectMeta</code> 类型，<code>spec</code> 字段则通过 <code>PodSpec</code> 和 <code>Container</code> 描述其中容器的镜像和名称，<code>ports</code> 通过 <code>ContainerPort</code> 类型描述。</p>
<h2 id="132-基于模型库重写配置"><a class="header" href="#132-基于模型库重写配置">1.3.2 基于模型库重写配置</a></h2>
<p>现在我们可以将以上代码合并保持到 <code>apps/deployment.k</code> 文件中作为一个自定义的模型库，这就是第一版 Konfig 雏形了（Konfig 开源模型库在 <code>base.pkg.kusion_kubernetes.api.apps.v1</code> 也提供了更完整的 <code>Deployment</code> 模型定义）。</p>
<p>现在可以创建 <code>main.k</code>，基于这个 <code>Deployment</code> 模型重新构造配置：</p>
<pre><code class="language-py">import apps

demo = apps.Deployment {
    metadata.name = &quot;nginx-deployment&quot;
    spec = {
        replicas = 3
        selector.matchLabels = {
            app = &quot;nginx&quot;
        }
        template.spec.containers = [
            {
                name = &quot;nginx&quot;
                image = &quot;nginx:1.14.2&quot;
                ports = [
                    {containerPort = 80}
                ]
            }
        ]
    }
}
</code></pre>
<p>现在输入的 KCL 配置代码虽然和原来的 YAML 文件差不多，但是获得了 Konfig 模型库提供的静态化类型和运行时校验规则的能力，同时可以配合 IDE 插件获得更好的编码效率，也可以让我们写的配置代码更安全。然后通过 <code>kcl main.k</code> 命令可以将模型渲染出之前的 YAML 文件了。</p>
<h2 id="133-konfig-诞生的背景"><a class="header" href="#133-konfig-诞生的背景">1.3.3 Konfig 诞生的背景</a></h2>
<p>从本节的例子可以发现，相对于我们的业务配置代码，底层模型的抽象代码更多。真实 Konfig 模型库中的 <code>Deployment</code> 代码更加庞大，同时也提供了更加完整灵活的静态类型和规则检查保障。Konfig 最初朴素的出发点就是改善 YAML 用户的效率和体验，我们希望通过将代码更繁杂的模型抽象封装到统一的模型库中，从而简化用户侧配置代码的编写。</p>
<p>Konfig 的前身是蚂蚁在落地 IaC&amp;GitOps 的过程中采用的是 Konfig 大库。蚂蚁开始就把所有的 IaC 配置代码维护在一个统一的 Konfig 大仓库中，代码包括基础配置代码和业务配置代码两部分。之所以用一个大的仓库管理全部的 IaC 配置代码，是由于蚂蚁内部不同代码包的研发主体不同，会引发出包管理和版本管理的问题，从而导致平台侧需要支持类似编译平台的能力。采用大库模式下，业务配置代码、基础配置代码在一个大库中，因此代码间的版本依赖管理比较简单，平台侧处理也比较简单，定位唯一代码库的目录及文件即可，代码互通，统一管理，便于查找、修改、维护（大库模式也是 Google 等头部互联网公司内部实践的模式）。</p>
<p>大库模式虽然有版本管理简单等优点，但是缺点也非常多：比如大库导致仓库体积爆炸的问题会给网络下载带来更大的压力，因此不适合开源社区的分布式、异步协作的开发模式。因此当 Kusion 项目绝对开源后，我们对 Konfig 大库做了大量改造和拆分工作，核心目标是将和 Kubernetes 相关的基础模型保留，将和蚂蚁内部业务耦合比较紧密的业务代码剥离（业务相关部分的最佳实践方式会在案例实践场景中体现）。因此开源版本的 Konfig 库可以看作是 Kusion 项目针对 Kubernetes 云原生的开放生态提供基础设施模型库，这样可以帮助用户以较少的配置代码部署和运维 Kubernetes 生态的应用。同时我们希望和社区共建的方式完善和改进 Kubernetes 生态的基础设施模型库。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ch1-intro/ch1.2-kcl.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../ch1-intro/ch1.4-kusion.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ch1-intro/ch1.2-kcl.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../ch1-intro/ch1.4-kusion.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
